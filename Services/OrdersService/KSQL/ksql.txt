//SET TO EARLIEST
SET 'auto.offset.reset'='earliest';

// ORDERS STREAMS
CREATE STREAM OrdersCommandsStream (User VARCHAR, Product VARCHAR, Quantity INT) WITH (kafka_topic='ORDERSSERVICECOMMANDS', key='Product', value_format='json');
CREATE TABLE OrdersByProduct WITH (KEY = 'Product') as select Product,count(*) as NumberOfRequests from OrdersCommandsStream group by Product;

//INVENTORY STREAMS
CREATE STREAM InventoryCommandsStream (User VARCHAR, Product VARCHAR, Quantity INT) WITH (kafka_topic='INVENTORYSERVICECOMMANDS', key='Product', value_format='json');
CREATE TABLE ProductStock as select Product,count(*) as Stock from InventoryCommandsStream group by Product;

// join
CREATE STREAM StockByProduct WITH AS  SELECT ps.product,ps.Stock - op.NumberOfRequests  FROM OrdersByProduct op JOIN ProductStock ps ON op.Product = ps.Product;



//terminate
DROP STREAM IF EXISTS OrdersCommandsStream DELETE TOPIC;
DROP STREAM IF EXISTS InventoryCommandsStream DELETE TOPIC;
DROP TABLE IF EXISTS OrdersByProduct DELETE TOPIC;
DROP TABLE IF EXISTS ProductStock DELETE TOPIC;
TERMINATE query_id;